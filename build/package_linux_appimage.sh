#!/usr/bin/env bash
set -euo pipefail

# Package a Linux AppImage from the PyInstaller output.
# Requires appimagetool installed on Linux.

APP_NAME_INTERNAL="FirebrandThermalAnalysis"
APP_NAME_DISPLAY="Firebrand Thermal Analysis"
DIST_DIR="dist/${APP_NAME_INTERNAL}"
APPDIR="build/AppDir"
OUT="dist/${APP_NAME_INTERNAL}.AppImage"
ICON_NAME="${APP_NAME_INTERNAL}"
ICON_PATH="${APPDIR}/${ICON_NAME}.png"

if [[ ! -d "$DIST_DIR" ]]; then
  echo "Expected ${DIST_DIR}. Run a Linux build with PyInstaller first." >&2
  exit 1
fi

rm -rf "$APPDIR"
mkdir -p "$APPDIR/usr/bin"
cp -R "$DIST_DIR" "$APPDIR/usr/bin/${APP_NAME_INTERNAL}"

cat > "$ICON_PATH.b64" <<'EOF'
iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAIAAADTED8xAAAC/ElEQVR42u3TQQ0AIAwEQQz1wxthSEQESnihAAEtk6yCy02L6NK3NRMIAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJACkJgD2HCgcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAABAIAAAEAAACAAABAAAAgAAAQAAAIAAAEAgAAAQAAAIAAAEAAACAAABAAAAgAAAQCAAABAAAAgAAAQAAAIAAAEAAACAAABAIAAAEAAACAAABAAAAgAAAQAAAIAAAEAgAAAQAAAIAAAEAAACAAABEANAGfN1AEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAEAAACAAABAAAAgAAAQAAAIAAAEAgAAAQAAAIAAAEAAACAAABAAAAgAAAQCAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAwEsAAEAAACAAABAAAAgAAAQAAAIAAAEAgAAAQAAAIAAAEAAACAAABAAAAgAAAQCAAABAAAAgAAAQAAAIAAAEAAACAAABIP0YAAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAenQBgOk+xZ/N+oMAAAAASUVORK5CYII=
EOF
base64 --decode "$ICON_PATH.b64" > "$ICON_PATH"
rm -f "$ICON_PATH.b64"

cat > "$APPDIR/AppRun" <<'EOF'
#!/usr/bin/env bash
HERE="$(dirname "$(readlink -f "$0")")"
exec "$HERE/usr/bin/FirebrandThermalAnalysis/FirebrandThermalAnalysis" "$@"
EOF
chmod +x "$APPDIR/AppRun"

cat > "$APPDIR/${APP_NAME_INTERNAL}.desktop" <<EOF
[Desktop Entry]
Type=Application
Name=${APP_NAME_DISPLAY}
Exec=${APP_NAME_INTERNAL}
Icon=${ICON_NAME}
Terminal=false
Categories=Utility;
EOF

export APPIMAGE_COMPRESS="${APPIMAGE_COMPRESS:-xz}"
appimagetool "$APPDIR" "$OUT"
echo "AppImage created at: $OUT"
